<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrdineDAOImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">popix</a> &gt; <a href="index.source.html" class="el_package">com.popx.persistenza</a> &gt; <span class="el_source">OrdineDAOImpl.java</span></div><h1>OrdineDAOImpl.java</h1><pre class="source lang-java linenums">package com.popx.persistenza;

import com.popx.modello.OrdineBean;

import javax.sql.DataSource;
import java.sql.*;
import java.util.ArrayList;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;

public class OrdineDAOImpl implements OrdineDAO {

    private DataSource ds;
<span class="fc" id="L15">    private static final Logger LOGGER = Logger.getLogger(OrdineDAOImpl.class.getName());</span>

    /*@ public model boolean available;
      @ public invariant ds != null &amp;&amp; available;
      @ represents available &lt;- ds != null;
      @*/

<span class="fc" id="L22">    public OrdineDAOImpl() {</span>
<span class="fc" id="L23">        this.ds = DataSourceSingleton.getInstance();</span>
<span class="fc" id="L24">    }</span>

    @Override
    /*@ public normal_behavior
      @   requires ordine != null
      @        &amp;&amp; ordine.getSubtotal() &gt;= 0
      @        &amp;&amp; ordine.getCustomerEmail() != null &amp;&amp; !ordine.getCustomerEmail().isEmpty()
      @        &amp;&amp; ordine.getStatus() != null &amp;&amp; !ordine.getStatus().isEmpty()
      @        &amp;&amp; ordine.getDataOrdine() != null;
      @   assignable \everything;
      @   ensures \result ==&gt; ordine.getId() &gt; 0;
      @*/
    public boolean insertOrdine(OrdineBean ordine) {
<span class="fc" id="L37">        String query = &quot;INSERT INTO Ordine (subtotal, customer_email, status, data_ordine) VALUES (?, ?, ?, ?)&quot;;</span>

<span class="fc" id="L39">        try (Connection con = ds.getConnection();</span>
<span class="fc" id="L40">             PreparedStatement ps = con.prepareStatement(query, PreparedStatement.RETURN_GENERATED_KEYS)) {</span>

<span class="fc" id="L42">            ps.setFloat(1, ordine.getSubtotal());</span>
<span class="fc" id="L43">            ps.setString(2, ordine.getCustomerEmail());</span>
<span class="fc" id="L44">            ps.setString(3, ordine.getStatus());</span>
<span class="fc" id="L45">            ps.setDate(4, new java.sql.Date(ordine.getDataOrdine().getTime()));</span>

<span class="fc" id="L47">            int affectedRows = ps.executeUpdate();</span>

            // Recupera l'ID auto-generato
<span class="fc" id="L50">            ResultSet rs = ps.getGeneratedKeys();</span>
<span class="pc bpc" id="L51" title="1 of 2 branches missed.">            if (rs.next()) {</span>
<span class="fc" id="L52">                ordine.setId(rs.getInt(1));</span>
            }

            // Restituisce true se sono state modificate righe (quindi l'inserimento è riuscito)
<span class="pc bpc" id="L56" title="1 of 2 branches missed.">            return affectedRows &gt; 0;</span>

<span class="nc" id="L58">        } catch (SQLException e) {</span>
<span class="nc" id="L59">            LOGGER.log(Level.SEVERE, &quot;SQL error in insertOrdine&quot;, e);</span>
<span class="nc" id="L60">            return false; // Restituisce false in caso di errore</span>
        }
    }


    @Override
    /*@ public normal_behavior
      @   requires id &gt; 0;
      @   assignable \everything;
      @   ensures \result == null || \result.getId() == id;
      @*/
    public OrdineBean getOrdineById(int id) {
<span class="fc" id="L72">        String query = &quot;SELECT * FROM Ordine WHERE id = ?&quot;;</span>
<span class="fc" id="L73">        OrdineBean ordine = null;</span>

<span class="fc" id="L75">        try (Connection con = ds.getConnection();</span>
<span class="fc" id="L76">             PreparedStatement ps = con.prepareStatement(query)) {</span>

<span class="fc" id="L78">            ps.setInt(1, id);</span>
<span class="fc" id="L79">            ResultSet rs = ps.executeQuery();</span>

<span class="fc bfc" id="L81" title="All 2 branches covered.">            if (rs.next()) {</span>
<span class="fc" id="L82">                ordine = new OrdineBean();</span>
<span class="fc" id="L83">                ordine.setId(rs.getInt(&quot;id&quot;));</span>
<span class="fc" id="L84">                ordine.setSubtotal(rs.getFloat(&quot;subtotal&quot;));</span>
<span class="fc" id="L85">                ordine.setCustomerEmail(rs.getString(&quot;customer_email&quot;));</span>
<span class="fc" id="L86">                ordine.setStatus(rs.getString(&quot;status&quot;));</span>
<span class="fc" id="L87">                ordine.setDataOrdine(rs.getDate(&quot;data_ordine&quot;));</span>
            }

<span class="nc" id="L90">        } catch (SQLException e) {</span>
<span class="nc" id="L91">            LOGGER.log(Level.SEVERE, &quot;SQL error in getOrdineById&quot;, e);</span>
<span class="fc" id="L92">        }</span>

<span class="fc" id="L94">        return ordine;</span>
    }

    @Override
    /*@ public normal_behavior
      @   assignable \everything;
      @   ensures \result != null;
      @*/
    public List&lt;OrdineBean&gt; getAllOrdini() {
<span class="fc" id="L103">        String query = &quot;SELECT * FROM Ordine&quot;;</span>
<span class="fc" id="L104">        List&lt;OrdineBean&gt; ordini = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L106">        try (Connection con = ds.getConnection();</span>
<span class="fc" id="L107">             PreparedStatement ps = con.prepareStatement(query);</span>
<span class="fc" id="L108">             ResultSet rs = ps.executeQuery()) {</span>

<span class="fc bfc" id="L110" title="All 2 branches covered.">            while (rs.next()) {</span>
<span class="fc" id="L111">                OrdineBean ordine = new OrdineBean();</span>
<span class="fc" id="L112">                ordine.setId(rs.getInt(&quot;id&quot;));</span>
<span class="fc" id="L113">                ordine.setSubtotal(rs.getFloat(&quot;subtotal&quot;));</span>
<span class="fc" id="L114">                ordine.setCustomerEmail(rs.getString(&quot;customer_email&quot;));</span>
<span class="fc" id="L115">                ordine.setStatus(rs.getString(&quot;status&quot;));</span>
<span class="fc" id="L116">                ordine.setDataOrdine(rs.getDate(&quot;data_ordine&quot;));</span>
<span class="fc" id="L117">                ordini.add(ordine);</span>
<span class="fc" id="L118">            }</span>

<span class="nc" id="L120">        } catch (SQLException e) {</span>
<span class="nc" id="L121">            LOGGER.log(Level.SEVERE, &quot;SQL error in getAllOrdini&quot;, e);</span>
<span class="fc" id="L122">        }</span>

<span class="fc" id="L124">        return ordini;</span>
    }

    @Override
    /*@ public normal_behavior
      @   requires clienteEmail != null &amp;&amp; !clienteEmail.isEmpty();
      @   assignable \everything;
      @   ensures \result != null
      @        &amp;&amp; (\forall int i; 0 &lt;= i &amp;&amp; i &lt; \result.size();
      @              \result.get(i) != null
      @           &amp;&amp; clienteEmail.equals(\result.get(i).getCustomerEmail()));
      @*/
    public List&lt;OrdineBean&gt; getOrdiniByCliente(String clienteEmail) {
<span class="fc" id="L137">        String query = &quot;SELECT * FROM Ordine WHERE customer_email = ?&quot;;</span>
<span class="fc" id="L138">        List&lt;OrdineBean&gt; ordini = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L140">        try (Connection con = ds.getConnection();</span>
<span class="fc" id="L141">             PreparedStatement ps = con.prepareStatement(query)) {</span>

<span class="fc" id="L143">            ps.setString(1, clienteEmail);</span>
<span class="fc" id="L144">            ResultSet rs = ps.executeQuery();</span>

<span class="fc bfc" id="L146" title="All 2 branches covered.">            while (rs.next()) {</span>
<span class="fc" id="L147">                OrdineBean ordine = new OrdineBean();</span>
<span class="fc" id="L148">                ordine.setId(rs.getInt(&quot;id&quot;));</span>
<span class="fc" id="L149">                ordine.setSubtotal(rs.getFloat(&quot;subtotal&quot;));</span>
<span class="fc" id="L150">                ordine.setCustomerEmail(rs.getString(&quot;customer_email&quot;));</span>
<span class="fc" id="L151">                ordine.setStatus(rs.getString(&quot;status&quot;));</span>
<span class="fc" id="L152">                ordine.setDataOrdine(rs.getDate(&quot;data_ordine&quot;));</span>
<span class="fc" id="L153">                ordini.add(ordine);</span>
<span class="fc" id="L154">            }</span>

<span class="nc" id="L156">        } catch (SQLException e) {</span>
<span class="nc" id="L157">            LOGGER.log(Level.SEVERE, &quot;SQL error in getOrdiniByCliente&quot;, e);</span>
<span class="fc" id="L158">        }</span>

<span class="fc" id="L160">        return ordini;</span>
    }

    @Override
    /*@ public normal_behavior
      @   requires email != null &amp;&amp; !email.isEmpty();
      @   assignable \everything;
      @   ensures \result &gt;= 0;
      @*/
    public int countOrdiniByCliente(String email) {
<span class="nc" id="L170">        int count = 0;</span>
<span class="nc" id="L171">        try (Connection connection = ds.getConnection()) {</span>
<span class="nc" id="L172">            String query = &quot;SELECT COUNT(*) FROM Ordine WHERE customer_email = ?&quot;;</span>
<span class="nc" id="L173">            try (PreparedStatement preparedStatement = connection.prepareStatement(query)) {</span>
<span class="nc" id="L174">                preparedStatement.setString(1, email);</span>
<span class="nc" id="L175">                ResultSet resultSet = preparedStatement.executeQuery();</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">                if (resultSet.next()) {</span>
<span class="nc" id="L177">                    count = resultSet.getInt(1);</span>
                }
            }
<span class="nc" id="L180">        } catch (SQLException e) {</span>
<span class="nc" id="L181">            LOGGER.log(Level.SEVERE, &quot;SQL error in countOrdiniByCliente&quot;, e);</span>
<span class="nc" id="L182">        }</span>
<span class="nc" id="L183">        return count;</span>
    }

    @Override
    /*@ public normal_behavior
      @   requires email != null &amp;&amp; !email.isEmpty()
      @        &amp;&amp; currentPage &gt;= 1
      @        &amp;&amp; itemsPerPage &gt; 0;
      @   assignable \everything;
      @   ensures \result != null &amp;&amp; \result.size() &lt;= itemsPerPage;
      @*/
    public List&lt;OrdineBean&gt; getOrdiniByClientePaginati(String email, int currentPage, int itemsPerPage) {
<span class="nc" id="L195">        List&lt;OrdineBean&gt; ordini = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L196">        try (Connection connection = ds.getConnection()) {</span>
<span class="nc" id="L197">            int offset = (currentPage - 1) * itemsPerPage;</span>
<span class="nc" id="L198">            String query = &quot;SELECT id, subtotal, status, data_ordine FROM Ordine WHERE customer_email = ? ORDER BY data_ordine DESC LIMIT ? OFFSET ?&quot;;</span>
<span class="nc" id="L199">            try (PreparedStatement preparedStatement = connection.prepareStatement(query)) {</span>
<span class="nc" id="L200">                preparedStatement.setString(1, email);</span>
<span class="nc" id="L201">                preparedStatement.setInt(2, itemsPerPage);</span>
<span class="nc" id="L202">                preparedStatement.setInt(3, offset);</span>
<span class="nc" id="L203">                ResultSet resultSet = preparedStatement.executeQuery();</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">                while (resultSet.next()) {</span>
<span class="nc" id="L205">                    OrdineBean ordine = new OrdineBean();</span>
<span class="nc" id="L206">                    ordine.setId(resultSet.getInt(&quot;id&quot;));</span>
<span class="nc" id="L207">                    ordine.setSubtotal(resultSet.getFloat(&quot;subtotal&quot;));</span>
<span class="nc" id="L208">                    ordine.setStatus(resultSet.getString(&quot;status&quot;));</span>
<span class="nc" id="L209">                    ordine.setDataOrdine(resultSet.getDate(&quot;data_ordine&quot;));</span>
<span class="nc" id="L210">                    ordini.add(ordine);</span>
<span class="nc" id="L211">                }</span>
            }
<span class="nc" id="L213">        } catch (SQLException e) {</span>
<span class="nc" id="L214">            LOGGER.log(Level.SEVERE, &quot;SQL error in getOrdiniByClientePaginati&quot;, e);</span>
<span class="nc" id="L215">        }</span>
<span class="nc" id="L216">        return ordini;</span>
    }

    @Override
    /*@ public normal_behavior
      @   requires currentPage &gt;= 1 &amp;&amp; recordsPerPage &gt; 0;
      @   assignable \everything;
      @   ensures \result != null &amp;&amp; \result.size() &lt;= recordsPerPage;
      @*/
    public List&lt;OrdineBean&gt; getOrdiniPaginati(int currentPage, int recordsPerPage) {
<span class="nc" id="L226">        List&lt;OrdineBean&gt; ordini = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L227">        String query = &quot;SELECT * FROM Ordine LIMIT ? OFFSET ?&quot;;</span>

<span class="nc" id="L229">        try (Connection conn = ds.getConnection();</span>
<span class="nc" id="L230">             PreparedStatement pstmt = conn.prepareStatement(query)) {</span>

<span class="nc" id="L232">            pstmt.setInt(1, recordsPerPage);</span>
<span class="nc" id="L233">            pstmt.setInt(2, (currentPage - 1) * recordsPerPage);</span>

<span class="nc" id="L235">            try (ResultSet rs = pstmt.executeQuery()) {</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L237">                    OrdineBean ordine = new OrdineBean();</span>
<span class="nc" id="L238">                    ordine.setId(rs.getInt(&quot;id&quot;));</span>
<span class="nc" id="L239">                    ordine.setSubtotal(rs.getFloat(&quot;subtotal&quot;));</span>
<span class="nc" id="L240">                    ordine.setCustomerEmail(rs.getString(&quot;customer_email&quot;));</span>
<span class="nc" id="L241">                    ordine.setStatus(rs.getString(&quot;status&quot;));</span>
<span class="nc" id="L242">                    ordine.setDataOrdine(rs.getDate(&quot;data_ordine&quot;));</span>
<span class="nc" id="L243">                    ordini.add(ordine);</span>
<span class="nc" id="L244">                }</span>
            }
<span class="nc" id="L246">        } catch (SQLException e) {</span>
<span class="nc" id="L247">            LOGGER.log(Level.SEVERE, &quot;SQL error in getOrdiniPaginati&quot;, e);</span>
<span class="nc" id="L248">        }</span>

<span class="nc" id="L250">        return ordini;</span>
    }

    @Override
    /*@ public normal_behavior
      @   assignable \everything;
      @   ensures \result &gt;= 0;
      @*/
    public int countTuttiOrdini() {
<span class="nc" id="L259">        int count = 0;</span>
<span class="nc" id="L260">        String query = &quot;SELECT COUNT(*) FROM Ordine&quot;;</span>

<span class="nc" id="L262">        try (Connection conn = ds.getConnection();</span>
<span class="nc" id="L263">             Statement stmt = conn.createStatement();</span>
<span class="nc" id="L264">             ResultSet rs = stmt.executeQuery(query)) {</span>

<span class="nc bnc" id="L266" title="All 2 branches missed.">            if (rs.next()) {</span>
<span class="nc" id="L267">                count = rs.getInt(1);</span>
            }
<span class="nc" id="L269">        } catch (SQLException e) {</span>
<span class="nc" id="L270">            LOGGER.log(Level.SEVERE, &quot;SQL error in countTuttiOrdini&quot;, e);</span>
<span class="nc" id="L271">        }</span>

<span class="nc" id="L273">        return count;</span>
    }

    @Override
    /*@ public normal_behavior
      @   requires ordineBean != null
      @        &amp;&amp; ordineBean.getId() &gt; 0
      @        &amp;&amp; ordineBean.getStatus() != null &amp;&amp; !ordineBean.getStatus().isEmpty();
      @   assignable \everything;
      @   ensures \result ==&gt; true;
      @*/
    public boolean updateStatus(OrdineBean ordineBean) {
<span class="fc" id="L285">        String sql = &quot;UPDATE Ordine SET status = ? WHERE id = ?&quot;;</span>
<span class="fc" id="L286">        try (Connection conn = ds.getConnection();</span>
<span class="fc" id="L287">             PreparedStatement preparedStatement = conn.prepareStatement(sql)) {</span>

            // Impostazione dei parametri della query
<span class="fc" id="L290">            preparedStatement.setString(1, ordineBean.getStatus());</span>
<span class="fc" id="L291">            preparedStatement.setInt(2, ordineBean.getId());</span>

            // Esecuzione dell'aggiornamento
<span class="fc" id="L294">            int rowsUpdated = preparedStatement.executeUpdate();</span>
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">            return rowsUpdated &gt; 0; // Restituisce true se almeno una riga è stata aggiornata</span>
<span class="nc" id="L296">        } catch (SQLException e) {</span>
<span class="nc" id="L297">            LOGGER.log(Level.SEVERE, &quot;SQL error in updateStatus&quot;, e);</span>
<span class="nc" id="L298">            return false; // Gestisce l'errore restituendo false</span>
        }
    }



}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>