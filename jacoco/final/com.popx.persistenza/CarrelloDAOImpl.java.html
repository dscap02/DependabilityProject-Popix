<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CarrelloDAOImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">popix</a> &gt; <a href="index.source.html" class="el_package">com.popx.persistenza</a> &gt; <span class="el_source">CarrelloDAOImpl.java</span></div><h1>CarrelloDAOImpl.java</h1><pre class="source lang-java linenums">package com.popx.persistenza;

import com.popx.modello.CarrelloBean;
import com.popx.modello.ProdottoCarrelloBean;
import javax.sql.DataSource;
import java.sql.*;
import java.util.*;
import java.util.logging.Level;
import java.util.logging.Logger;

public class CarrelloDAOImpl implements CarrelloDAO {
    private DataSource ds;
<span class="fc" id="L13">    private static final Logger LOGGER = Logger.getLogger(CarrelloDAOImpl.class.getName());</span>

    /*@ public model boolean available;
      @ public invariant ds != null &amp;&amp; available;
      @ represents available &lt;- ds != null;
      @*/

<span class="fc" id="L20">    public CarrelloDAOImpl() {</span>
<span class="fc" id="L21">        this.ds = DataSourceSingleton.getInstance();</span>
<span class="fc" id="L22">    }</span>


    /*@ public normal_behavior
      @   requires carrello != null
      @        &amp;&amp; carrello.getClienteEmail() != null &amp;&amp; !carrello.getClienteEmail().isEmpty()
      @        &amp;&amp; carrello.getProdottiCarrello() != null
      @        &amp;&amp; (\forall int i; 0 &lt;= i &amp;&amp; i &lt; carrello.getProdottiCarrello().size();
      @              carrello.getProdottiCarrello().get(i) != null
      @           &amp;&amp; carrello.getProdottiCarrello().get(i).getProdottoId() != null
      @           &amp;&amp; !carrello.getProdottiCarrello().get(i).getProdottoId().isEmpty()
      @           &amp;&amp; carrello.getProdottiCarrello().get(i).getQuantity() &gt;= 0
      @           &amp;&amp; carrello.getProdottiCarrello().get(i).getUnitaryCost() &gt;= 0);
      @   assignable \everything;
      @   ensures available;
      @*/
    @Override
    public void salvaCarrello(CarrelloBean carrello) {
<span class="fc" id="L40">        String upsertCart =</span>
                &quot;INSERT INTO Carrello (cliente_email) VALUES (?) &quot; +
                        &quot;ON DUPLICATE KEY UPDATE id = LAST_INSERT_ID(id)&quot;;

<span class="fc" id="L44">        String insertProdottoCarrello =</span>
                &quot;INSERT INTO ProdottoCarrello (carrello_id, prodotto_id, quantity, unitary_cost) &quot; +
                        &quot;VALUES (?, ?, ?, ?) &quot; +
                        &quot;ON DUPLICATE KEY UPDATE quantity = VALUES(quantity), unitary_cost = VALUES(unitary_cost)&quot;;

<span class="fc" id="L49">        try (Connection connection = ds.getConnection()) {</span>
<span class="fc" id="L50">            connection.setAutoCommit(false);</span>

            int carrelloId;

            // 1) Inserisci (o recupera) il carrello e ottieni l'id
<span class="fc" id="L55">            try (PreparedStatement psCart = connection.prepareStatement(upsertCart, Statement.RETURN_GENERATED_KEYS)) {</span>
<span class="fc" id="L56">                psCart.setString(1, carrello.getClienteEmail());</span>
<span class="fc" id="L57">                psCart.executeUpdate();</span>

<span class="fc" id="L59">                try (ResultSet keys = psCart.getGeneratedKeys()) {</span>
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">                    if (keys.next()) {</span>
<span class="fc" id="L61">                        carrelloId = keys.getInt(1);</span>
                    } else {
<span class="nc" id="L63">                        throw new SQLException(&quot;Impossibile ottenere l'ID del carrello.&quot;);</span>
                    }
                }
            }

            // 2) Inserisci/aggiorna prodotti del carrello (batch)
<span class="fc" id="L69">            try (PreparedStatement psProd = connection.prepareStatement(insertProdottoCarrello)) {</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">                for (ProdottoCarrelloBean prodotto : carrello.getProdottiCarrello()) {</span>
<span class="fc" id="L71">                    psProd.setInt(1, carrelloId);</span>
<span class="fc" id="L72">                    psProd.setString(2, prodotto.getProdottoId());</span>
<span class="fc" id="L73">                    psProd.setInt(3, prodotto.getQuantity());</span>
<span class="fc" id="L74">                    psProd.setFloat(4, prodotto.getUnitaryCost());</span>
<span class="fc" id="L75">                    psProd.addBatch();</span>
<span class="fc" id="L76">                }</span>
<span class="fc" id="L77">                psProd.executeBatch();</span>
            }

<span class="fc" id="L80">            connection.commit();</span>

<span class="nc" id="L82">        } catch (SQLException e) {</span>
<span class="nc" id="L83">            LOGGER.log(Level.SEVERE, &quot;SQL error in salvaCarrello&quot;, e);</span>
<span class="fc" id="L84">        }</span>
<span class="fc" id="L85">    }</span>


    @Override
    /*@ public normal_behavior
      @   requires email != null &amp;&amp; !email.isEmpty();
      @   assignable \everything;
      @   ensures \result != null
      @        &amp;&amp; \result.getClienteEmail().equals(email)
      @        &amp;&amp; \result.getProdottiCarrello() != null
      @        &amp;&amp; (\forall int i; 0 &lt;= i &amp;&amp; i &lt; \result.getProdottiCarrello().size();
      @              \result.getProdottiCarrello().get(i) != null
      @           &amp;&amp; \result.getProdottiCarrello().get(i).getProdottoId() != null
      @           &amp;&amp; !\result.getProdottiCarrello().get(i).getProdottoId().isEmpty()
      @           &amp;&amp; \result.getProdottiCarrello().get(i).getQuantity() &gt;= 0
      @           &amp;&amp; \result.getProdottiCarrello().get(i).getUnitaryCost() &gt;= 0);
      @*/
    public CarrelloBean ottieniCarrelloPerEmail(String email) {
<span class="fc" id="L103">        String queryCarrello = &quot;SELECT * FROM Carrello WHERE cliente_email = ?&quot;;</span>
<span class="fc" id="L104">        String queryProdotti = &quot;SELECT * FROM ProdottoCarrello WHERE carrello_id = ?&quot;;</span>

<span class="fc" id="L106">        CarrelloBean carrello = null;</span>
<span class="fc" id="L107">        List&lt;ProdottoCarrelloBean&gt; prodottiCarrello = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L109">        try (Connection connection = ds.getConnection()) {</span>
            // Recupera il carrello
<span class="fc" id="L111">            try (PreparedStatement psCarrello = connection.prepareStatement(queryCarrello)) {</span>
<span class="fc" id="L112">                psCarrello.setString(1, email);</span>
<span class="fc" id="L113">                ResultSet rsCarrello = psCarrello.executeQuery();</span>

<span class="fc bfc" id="L115" title="All 2 branches covered.">                if (rsCarrello.next()) {</span>
                    // Recupera l'ID del carrello
<span class="fc" id="L117">                    int carrelloId = rsCarrello.getInt(&quot;id&quot;);</span>

                    // Recupera i prodotti associati al carrello
<span class="fc" id="L120">                    try (PreparedStatement psProdotti = connection.prepareStatement(queryProdotti)) {</span>
<span class="fc" id="L121">                        psProdotti.setInt(1, carrelloId);</span>
<span class="fc" id="L122">                        ResultSet rsProdotti = psProdotti.executeQuery();</span>

<span class="fc bfc" id="L124" title="All 2 branches covered.">                        while (rsProdotti.next()) {</span>
<span class="fc" id="L125">                            ProdottoCarrelloBean prodotto = new ProdottoCarrelloBean(</span>
                                    email,
<span class="fc" id="L127">                                    rsProdotti.getString(&quot;prodotto_id&quot;),</span>
<span class="fc" id="L128">                                    rsProdotti.getInt(&quot;quantity&quot;),</span>
<span class="fc" id="L129">                                    rsProdotti.getFloat(&quot;unitary_cost&quot;)</span>
                            );
<span class="fc" id="L131">                            prodottiCarrello.add(prodotto);</span>
<span class="fc" id="L132">                        }</span>
                    }

                    // Crea il carrello
<span class="fc" id="L136">                    carrello = new CarrelloBean(email, prodottiCarrello);</span>
                }
            }
<span class="nc" id="L139">        } catch (SQLException e) {</span>
<span class="nc" id="L140">            LOGGER.log(Level.SEVERE, &quot;SQL error in ottieniCarrelloPerEmail&quot;, e);</span>
<span class="fc" id="L141">        }</span>

<span class="fc bfc" id="L143" title="All 2 branches covered.">        return carrello != null ? carrello : new CarrelloBean(email, prodottiCarrello);</span>
    }

    @Override
    /*@ public normal_behavior
      @   requires email != null &amp;&amp; !email.isEmpty();
      @   assignable \everything;
      @   ensures available;
      @*/
    public void clearCartByUserEmail(String email) {
<span class="fc" id="L153">        String queryProdottoCarrello =</span>
                &quot;DELETE FROM ProdottoCarrello WHERE carrello_id = (SELECT id FROM Carrello WHERE cliente_email = ?)&quot;;
<span class="fc" id="L155">        String queryCarrello =</span>
                &quot;DELETE FROM Carrello WHERE cliente_email = ?&quot;;

<span class="fc" id="L158">        try (Connection connection = ds.getConnection()) {</span>
<span class="fc" id="L159">            connection.setAutoCommit(false);</span>

<span class="fc" id="L161">            try (PreparedStatement psProdottoCarrello = connection.prepareStatement(queryProdottoCarrello);</span>
<span class="fc" id="L162">                 PreparedStatement psCarrello = connection.prepareStatement(queryCarrello)) {</span>

<span class="fc" id="L164">                psProdottoCarrello.setString(1, email);</span>
<span class="fc" id="L165">                psProdottoCarrello.executeUpdate();</span>

<span class="fc" id="L167">                psCarrello.setString(1, email);</span>
<span class="fc" id="L168">                psCarrello.executeUpdate();</span>

<span class="fc" id="L170">                connection.commit();</span>
<span class="nc" id="L171">            } catch (SQLException ex) {</span>
                // se qualcosa va male durante i DELETE, rollback della transazione
                try {
<span class="nc" id="L174">                    connection.rollback();</span>
<span class="nc" id="L175">                } catch (SQLException rollbackEx) {</span>
<span class="nc" id="L176">                    LOGGER.log(Level.SEVERE, &quot;Error during rollback in clearCartByUserEmail&quot;, rollbackEx);</span>
<span class="nc" id="L177">                }</span>
<span class="nc" id="L178">                throw ex; // rilancia per finire nel catch esterno</span>
            } finally {
                // best-effort: ripristina autocommit prima della chiusura
                try {
<span class="fc" id="L182">                    connection.setAutoCommit(true);</span>
<span class="nc" id="L183">                } catch (SQLException ignore) {</span>
                    // ignore / log se preferisci
<span class="fc" id="L185">                }</span>
            }

<span class="nc" id="L188">        } catch (SQLException e) {</span>
<span class="nc" id="L189">            LOGGER.log(Level.SEVERE, &quot;SQL error in clearCartByUserEmail&quot;, e);</span>
<span class="fc" id="L190">        }</span>
<span class="fc" id="L191">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>