<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProdottoDAOImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">popix</a> &gt; <a href="index.source.html" class="el_package">com.popx.persistenza</a> &gt; <span class="el_source">ProdottoDAOImpl.java</span></div><h1>ProdottoDAOImpl.java</h1><pre class="source lang-java linenums">package com.popx.persistenza;

import com.popx.modello.ProdottoBean;

import javax.servlet.http.HttpSession;
import javax.sql.DataSource;
import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class ProdottoDAOImpl implements ProdottoDAO {

    private final DataSource ds;

    /*@ public model boolean available;
      @ public invariant ds != null &amp;&amp; available;
      @ represents available &lt;- ds != null;
      @*/

<span class="fc" id="L20">    public ProdottoDAOImpl(DataSource ds) {</span>
<span class="fc" id="L21">        this.ds = ds;</span>
<span class="fc" id="L22">    }</span>

    public ProdottoDAOImpl() {
<span class="fc" id="L25">        this(DataSourceSingleton.getInstance());</span>
<span class="fc" id="L26">    }</span>

    @Override
    /*@ public normal_behavior
      @   requires prodotto != null
      @        &amp;&amp; prodotto.getId() != null &amp;&amp; !prodotto.getId().isEmpty()
      @        &amp;&amp; prodotto.getName() != null &amp;&amp; !prodotto.getName().isEmpty()
      @        &amp;&amp; prodotto.getBrand() != null &amp;&amp; !prodotto.getBrand().isEmpty()
      @        &amp;&amp; prodotto.getCost() &gt;= 0
      @        &amp;&amp; prodotto.getPiecesInStock() &gt;= 0;
      @   assignable \everything;
      @   ensures \result ==&gt; true;
      @*/
    public boolean saveProdotto(ProdottoBean prodotto) {
<span class="fc" id="L40">        String query = &quot;INSERT INTO Prodotto (id, name, description, cost, pieces_in_stock, brand, img, figure) VALUES (?, ?, ?, ?, ?, ?, ?, ?)&quot;;</span>
<span class="fc" id="L41">        try (Connection connection = ds.getConnection();</span>
<span class="fc" id="L42">             PreparedStatement statement = connection.prepareStatement(query)) {</span>
<span class="fc" id="L43">            statement.setString(1, prodotto.getId());</span>
<span class="fc" id="L44">            statement.setString(2, prodotto.getName());</span>
<span class="fc" id="L45">            statement.setString(3, prodotto.getDescription());</span>
<span class="fc" id="L46">            statement.setDouble(4, prodotto.getCost());</span>
<span class="fc" id="L47">            statement.setInt(5, prodotto.getPiecesInStock());</span>
<span class="fc" id="L48">            statement.setString(6, prodotto.getBrand());</span>
<span class="fc" id="L49">            statement.setBytes(7, prodotto.getImg());</span>
<span class="fc" id="L50">            statement.setString(8, prodotto.getFigure());  // Set the figure field</span>
<span class="pc bpc" id="L51" title="1 of 2 branches missed.">            return statement.executeUpdate() &gt; 0;</span>
<span class="nc" id="L52">        } catch (SQLException e) {</span>
<span class="nc" id="L53">            e.printStackTrace();</span>
        }
<span class="nc" id="L55">        return false;</span>
    }

    @Override
    /*@ public normal_behavior
      @   requires id != null &amp;&amp; !id.isEmpty();
      @   assignable \everything;
      @   ensures \result == null || \result.getId().equals(id);
      @*/
    public ProdottoBean getProdottoById(String id) {
<span class="fc" id="L65">        String query = &quot;SELECT * FROM Prodotto WHERE id = ?&quot;;</span>
<span class="fc" id="L66">        try (Connection connection = ds.getConnection();</span>
<span class="fc" id="L67">             PreparedStatement statement = connection.prepareStatement(query)) {</span>
<span class="fc" id="L68">            statement.setString(1, id);</span>
<span class="fc" id="L69">            ResultSet resultSet = statement.executeQuery();</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">            if (resultSet.next()) {</span>
<span class="fc" id="L71">                return new ProdottoBean(</span>
<span class="fc" id="L72">                        resultSet.getString(&quot;id&quot;),</span>
<span class="fc" id="L73">                        resultSet.getString(&quot;name&quot;),</span>
<span class="fc" id="L74">                        resultSet.getString(&quot;description&quot;),</span>
<span class="fc" id="L75">                        resultSet.getDouble(&quot;cost&quot;),</span>
<span class="fc" id="L76">                        resultSet.getInt(&quot;pieces_in_stock&quot;),</span>
<span class="fc" id="L77">                        resultSet.getString(&quot;brand&quot;),</span>
<span class="fc" id="L78">                        resultSet.getBytes(&quot;img&quot;),</span>
<span class="fc" id="L79">                        resultSet.getString(&quot;figure&quot;)  // Retrieve the figure field</span>
                );
            }
<span class="pc bpc" id="L82" title="2 of 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L83">            e.printStackTrace();</span>
<span class="fc" id="L84">        }</span>
<span class="fc" id="L85">        return null;</span>
    }

    @Override
    /*@ public normal_behavior
      @   requires brand != null &amp;&amp; !brand.isEmpty();
      @   assignable \everything;
      @   ensures \result != null
      @        &amp;&amp; (\forall int i; 0 &lt;= i &amp;&amp; i &lt; \result.size();
      @              \result.get(i) != null
      @           &amp;&amp; brand.equals(\result.get(i).getBrand()));
      @*/
    public List&lt;ProdottoBean&gt; getProdottiByBrand(String brand) {
<span class="fc" id="L98">        List&lt;ProdottoBean&gt; prodotti = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L99">        String query = &quot;SELECT * FROM Prodotto WHERE brand = ?&quot;;</span>
<span class="fc" id="L100">        try (Connection connection = ds.getConnection();</span>
<span class="fc" id="L101">             PreparedStatement statement = connection.prepareStatement(query)) {</span>
<span class="fc" id="L102">            statement.setString(1, brand);</span>
<span class="fc" id="L103">            ResultSet resultSet = statement.executeQuery();</span>
<span class="fc bfc" id="L104" title="All 2 branches covered.">            while (resultSet.next()) {</span>
<span class="fc" id="L105">                prodotti.add(new ProdottoBean(</span>
<span class="fc" id="L106">                        resultSet.getString(&quot;id&quot;),</span>
<span class="fc" id="L107">                        resultSet.getString(&quot;name&quot;),</span>
<span class="fc" id="L108">                        resultSet.getString(&quot;description&quot;),</span>
<span class="fc" id="L109">                        resultSet.getDouble(&quot;cost&quot;),</span>
<span class="fc" id="L110">                        resultSet.getInt(&quot;pieces_in_stock&quot;),</span>
<span class="fc" id="L111">                        resultSet.getString(&quot;brand&quot;),</span>
<span class="fc" id="L112">                        resultSet.getBytes(&quot;img&quot;),</span>
<span class="fc" id="L113">                        resultSet.getString(&quot;figure&quot;)  // Retrieve the figure field</span>
                ));
            }
<span class="nc" id="L116">        } catch (SQLException e) {</span>
<span class="nc" id="L117">            e.printStackTrace();</span>
<span class="fc" id="L118">        }</span>
<span class="fc" id="L119">        return prodotti;</span>
    }

    @Override
    /*@ public normal_behavior
      @   requires brand != null &amp;&amp; !brand.isEmpty();
      @   assignable \everything;
      @   ensures \result != null
      @        &amp;&amp; (\forall int i; 0 &lt;= i &amp;&amp; i &lt; \result.size();
      @              \result.get(i) != null
      @           &amp;&amp; brand.equals(\result.get(i).getBrand()));
      @*/
    public List&lt;ProdottoBean&gt; getProdottiByBrandAndPrice(String brand, boolean ascending) {
<span class="fc" id="L132">        List&lt;ProdottoBean&gt; prodotti = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">        String query = &quot;SELECT * FROM Prodotto WHERE brand = ? ORDER BY cost &quot; + (ascending ? &quot;ASC&quot; : &quot;DESC&quot;);</span>
<span class="fc" id="L134">        try (Connection connection = ds.getConnection();</span>
<span class="fc" id="L135">             PreparedStatement statement = connection.prepareStatement(query)) {</span>
<span class="fc" id="L136">            statement.setString(1, brand);</span>
<span class="fc" id="L137">            ResultSet resultSet = statement.executeQuery();</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">            while (resultSet.next()) {</span>
<span class="fc" id="L139">                prodotti.add(new ProdottoBean(</span>
<span class="fc" id="L140">                        resultSet.getString(&quot;id&quot;),</span>
<span class="fc" id="L141">                        resultSet.getString(&quot;name&quot;),</span>
<span class="fc" id="L142">                        resultSet.getString(&quot;description&quot;),</span>
<span class="fc" id="L143">                        resultSet.getDouble(&quot;cost&quot;),</span>
<span class="fc" id="L144">                        resultSet.getInt(&quot;pieces_in_stock&quot;),</span>
<span class="fc" id="L145">                        resultSet.getString(&quot;brand&quot;),</span>
<span class="fc" id="L146">                        resultSet.getBytes(&quot;img&quot;),</span>
<span class="fc" id="L147">                        resultSet.getString(&quot;figure&quot;)  // Retrieve the figure field</span>
                ));
            }
<span class="nc" id="L150">        } catch (SQLException e) {</span>
<span class="nc" id="L151">            e.printStackTrace();</span>
<span class="fc" id="L152">        }</span>
<span class="fc" id="L153">        return prodotti;</span>
    }

    @Override
    /*@ public normal_behavior
      @   assignable \everything;
      @   ensures \result != null;
      @*/
    public List&lt;ProdottoBean&gt; getProdottiSortedByPrice(boolean ascending) {
<span class="fc" id="L162">        List&lt;ProdottoBean&gt; prodotti = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">        String query = &quot;SELECT * FROM Prodotto ORDER BY cost &quot; + (ascending ? &quot;ASC&quot; : &quot;DESC&quot;);</span>
<span class="fc" id="L164">        try (Connection connection = ds.getConnection();</span>
<span class="fc" id="L165">             PreparedStatement statement = connection.prepareStatement(query);</span>
<span class="fc" id="L166">             ResultSet resultSet = statement.executeQuery()) {</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">            while (resultSet.next()) {</span>
<span class="fc" id="L168">                prodotti.add(new ProdottoBean(</span>
<span class="fc" id="L169">                        resultSet.getString(&quot;id&quot;),</span>
<span class="fc" id="L170">                        resultSet.getString(&quot;name&quot;),</span>
<span class="fc" id="L171">                        resultSet.getString(&quot;description&quot;),</span>
<span class="fc" id="L172">                        resultSet.getDouble(&quot;cost&quot;),</span>
<span class="fc" id="L173">                        resultSet.getInt(&quot;pieces_in_stock&quot;),</span>
<span class="fc" id="L174">                        resultSet.getString(&quot;brand&quot;),</span>
<span class="fc" id="L175">                        resultSet.getBytes(&quot;img&quot;),</span>
<span class="fc" id="L176">                        resultSet.getString(&quot;figure&quot;)  // Retrieve the figure field</span>
                ));
            }
<span class="nc" id="L179">        } catch (SQLException e) {</span>
<span class="nc" id="L180">            e.printStackTrace();</span>
<span class="fc" id="L181">        }</span>
<span class="fc" id="L182">        return prodotti;</span>
    }

    @Override
    /*@ public normal_behavior
      @   requires id != null &amp;&amp; !id.isEmpty();
      @   assignable \everything;
      @   ensures \result == null || \result.length &gt;= 0;
      @*/
    public byte[] getProductImageById(String id) {
<span class="fc" id="L192">        String query = &quot;SELECT img FROM Prodotto WHERE id = ?&quot;;</span>
<span class="fc" id="L193">        try (Connection connection = ds.getConnection();</span>
<span class="fc" id="L194">             PreparedStatement statement = connection.prepareStatement(query)) {</span>
<span class="fc" id="L195">            statement.setString(1, id);</span>
<span class="fc" id="L196">            ResultSet resultSet = statement.executeQuery();</span>
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">            if (resultSet.next()) {</span>
<span class="fc" id="L198">                return resultSet.getBytes(&quot;img&quot;);</span>
            }
<span class="pc bpc" id="L200" title="2 of 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L201">            e.printStackTrace();</span>
<span class="nc" id="L202">        }</span>
<span class="nc" id="L203">        return null;</span>
    }

    @Override
    /*@ public normal_behavior
      @   assignable \everything;
      @   ensures \result != null;
      @*/
    public List&lt;ProdottoBean&gt; getAllProducts() {
<span class="fc" id="L212">        List&lt;ProdottoBean&gt; products = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L213">        String query = &quot;SELECT * FROM Prodotto ORDER BY id&quot;;</span>
<span class="fc" id="L214">        try (Connection con = ds.getConnection();</span>
<span class="fc" id="L215">             PreparedStatement ps = con.prepareStatement(query);</span>
<span class="fc" id="L216">             ResultSet rs = ps.executeQuery()) {</span>

<span class="fc bfc" id="L218" title="All 2 branches covered.">            while (rs.next()) {</span>
<span class="fc" id="L219">                ProdottoBean prodotto = new ProdottoBean();</span>
<span class="fc" id="L220">                prodotto.setId(rs.getString(&quot;id&quot;));</span>
<span class="fc" id="L221">                prodotto.setName(rs.getString(&quot;name&quot;));</span>
<span class="fc" id="L222">                prodotto.setDescription(rs.getString(&quot;description&quot;));</span>
<span class="fc" id="L223">                prodotto.setCost(rs.getDouble(&quot;cost&quot;));</span>
<span class="fc" id="L224">                prodotto.setPiecesInStock(rs.getInt(&quot;pieces_in_stock&quot;)); // Recupero del valore</span>
<span class="fc" id="L225">                prodotto.setBrand(rs.getString(&quot;brand&quot;));</span>
<span class="fc" id="L226">                prodotto.setImg(rs.getBytes(&quot;img&quot;));</span>
<span class="fc" id="L227">                prodotto.setFigure(rs.getString(&quot;figure&quot;));</span>
<span class="fc" id="L228">                products.add(prodotto);</span>
<span class="fc" id="L229">            }</span>
<span class="nc" id="L230">        } catch (SQLException e) {</span>
<span class="nc" id="L231">            e.printStackTrace();</span>
<span class="fc" id="L232">        }</span>
<span class="fc" id="L233">        return products;</span>
    }


    @Override
    /*@ public normal_behavior
      @   requires limit &gt; 0;
      @   assignable \everything;
      @   ensures \result != null &amp;&amp; \result.size() &lt;= limit;
      @*/
    public List&lt;ProdottoBean&gt; getRandomProducts(int limit) throws SQLException {
<span class="fc" id="L244">        List&lt;ProdottoBean&gt; products = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L245">        String query = &quot;SELECT * FROM Prodotto ORDER BY RAND() LIMIT ?&quot;;  // Usato ORDER BY RAND() per ottenere risultati casuali</span>

<span class="fc" id="L247">        try (Connection con = ds.getConnection(); // Assicurati che ds sia un DataSource valido</span>
<span class="fc" id="L248">             PreparedStatement ps = con.prepareStatement(query)) {</span>

<span class="fc" id="L250">            ps.setInt(1, limit);  // Imposta il parametro limit dinamicamente</span>

<span class="fc" id="L252">            try (ResultSet rs = ps.executeQuery()) {</span>
<span class="fc bfc" id="L253" title="All 2 branches covered.">                while (rs.next()) {</span>
<span class="fc" id="L254">                    ProdottoBean product = new ProdottoBean();</span>
<span class="fc" id="L255">                    product.setId(rs.getString(&quot;id&quot;));  // Verifica che 'id' sia di tipo String, altrimenti cambia a Integer</span>
<span class="fc" id="L256">                    product.setName(rs.getString(&quot;name&quot;));</span>
<span class="fc" id="L257">                    product.setBrand(rs.getString(&quot;brand&quot;));</span>
<span class="fc" id="L258">                    product.setCost(rs.getDouble(&quot;cost&quot;));</span>
<span class="fc" id="L259">                    product.setImg(rs.getBytes(&quot;img&quot;));</span>
<span class="fc" id="L260">                    product.setDescription(rs.getString(&quot;description&quot;));</span>
<span class="fc" id="L261">                    product.setFigure(rs.getString(&quot;figure&quot;));  // Set the figure field</span>
<span class="fc" id="L262">                    products.add(product);</span>
<span class="fc" id="L263">                }</span>
            }
        }
<span class="fc" id="L266">        return products;</span>
    }

    @Override
    /*@ public normal_behavior
      @   requires session != null
      @        &amp;&amp; productId != null &amp;&amp; !productId.isEmpty()
      @        &amp;&amp; qty &gt;= 0;
      @   assignable \everything;
      @   ensures true;
      @*/
    public void updateProductQtyInCart(HttpSession session, String productId, int qty) {
<span class="nc" id="L278">        List&lt;ProdottoBean&gt; cart = (List&lt;ProdottoBean&gt;) session.getAttribute(&quot;cart&quot;);</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">        if (cart != null) {</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">            for (ProdottoBean product : cart) {</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">                if (product.getId().equals(productId)) {</span>
<span class="nc" id="L282">                    product.setQty(qty);</span>
<span class="nc" id="L283">                    break;</span>
                }
<span class="nc" id="L285">            }</span>
        }
<span class="nc" id="L287">    }</span>

    @Override
    /*@ public normal_behavior
      @   requires session != null
      @        &amp;&amp; productId != null &amp;&amp; !productId.isEmpty();
      @   assignable \everything;
      @   ensures \result &gt;= 0;
      @*/
    public int getProductQtyInCart(HttpSession session, String productId) {
<span class="nc" id="L297">        List&lt;ProdottoBean&gt; cart = (List&lt;ProdottoBean&gt;) session.getAttribute(&quot;cart&quot;);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (cart != null) {</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">            for (ProdottoBean product : cart) {</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">                if (product.getId().equals(productId)) {</span>
<span class="nc" id="L301">                    return product.getQty();</span>
                }
<span class="nc" id="L303">            }</span>
        }
<span class="nc" id="L305">        return 0;</span>
    }

    @Override
    /*@ public normal_behavior
      @   requires userEmail != null &amp;&amp; !userEmail.isEmpty()
      @        &amp;&amp; cart != null
      @        &amp;&amp; (\forall int i; 0 &lt;= i &amp;&amp; i &lt; cart.size();
      @              cart.get(i) != null
      @           &amp;&amp; cart.get(i).getId() != null &amp;&amp; !cart.get(i).getId().isEmpty()
      @           &amp;&amp; cart.get(i).getQty() &gt;= 0
      @           &amp;&amp; cart.get(i).getCost() &gt;= 0);
      @   assignable \everything;
      @   ensures available;
      @*/
    public void saveCartToDatabase(String userEmail, List&lt;ProdottoBean&gt; cart) throws SQLException {
<span class="fc" id="L321">        String insertCartQuery = &quot;INSERT INTO Carrello (cliente_email) VALUES (?) &quot; +</span>
                &quot;ON DUPLICATE KEY UPDATE id=LAST_INSERT_ID(id)&quot;;

<span class="fc" id="L324">        String insertProductCartQuery = &quot;INSERT INTO ProdottoCarrello (carrello_id, prodotto_id, quantity, unitary_cost) &quot; +</span>
                &quot;VALUES (?, ?, ?, ?) &quot; +
                &quot;ON DUPLICATE KEY UPDATE quantity = VALUES(quantity), unitary_cost = VALUES(unitary_cost)&quot;;

<span class="fc" id="L328">        try (Connection connection = ds.getConnection();</span>
<span class="fc" id="L329">             PreparedStatement cartStmt = connection.prepareStatement(insertCartQuery, Statement.RETURN_GENERATED_KEYS);</span>
<span class="fc" id="L330">             PreparedStatement productCartStmt = connection.prepareStatement(insertProductCartQuery)) {</span>

            // Inserisci o aggiorna il carrello
<span class="fc" id="L333">            cartStmt.setString(1, userEmail);</span>
<span class="fc" id="L334">            cartStmt.executeUpdate();</span>

            // Ottieni l'ID del carrello
            int cartId;
<span class="fc" id="L338">            try (ResultSet rs = cartStmt.getGeneratedKeys()) {</span>
<span class="pc bpc" id="L339" title="1 of 2 branches missed.">                if (rs.next()) {</span>
<span class="fc" id="L340">                    cartId = rs.getInt(1);</span>
                } else {
<span class="nc" id="L342">                    throw new SQLException(&quot;Impossibile ottenere l'ID del carrello.&quot;);</span>
                }
            }

            // Inserisci o aggiorna i prodotti nel carrello
<span class="fc bfc" id="L347" title="All 2 branches covered.">            for (ProdottoBean product : cart) {</span>
<span class="fc" id="L348">                productCartStmt.setInt(1, cartId);</span>
<span class="fc" id="L349">                productCartStmt.setString(2, product.getId());</span>
<span class="fc" id="L350">                productCartStmt.setInt(3, product.getQty());</span>
<span class="fc" id="L351">                productCartStmt.setDouble(4, product.getCost());</span>

<span class="fc" id="L353">                productCartStmt.executeUpdate();</span>
<span class="fc" id="L354">            }</span>
        }
<span class="fc" id="L356">    }</span>

    @Override
    /*@ public normal_behavior
      @   requires userEmail != null &amp;&amp; !userEmail.isEmpty();
      @   assignable \everything;
      @   ensures \result != null
      @        &amp;&amp; (\forall int i; 0 &lt;= i &amp;&amp; i &lt; \result.size();
      @              \result.get(i) != null
      @           &amp;&amp; \result.get(i).getId() != null &amp;&amp; !\result.get(i).getId().isEmpty()
      @           &amp;&amp; \result.get(i).getQty() &gt;= 0);
      @*/
    public List&lt;ProdottoBean&gt; getCartByUserEmail(String userEmail) throws SQLException {
<span class="fc" id="L369">        List&lt;ProdottoBean&gt; cart = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L370">        String query = &quot;SELECT p.id, p.name, p.pieces_in_stock, p.cost, pc.quantity &quot; +</span>
                &quot;FROM Prodotto p &quot; +
                &quot;JOIN ProdottoCarrello pc ON p.id = pc.prodotto_id &quot; +
                &quot;JOIN Carrello c ON pc.carrello_id = c.id &quot; +
                &quot;WHERE c.cliente_email = ?&quot;;


<span class="fc" id="L377">        try (Connection connection = ds.getConnection();</span>
<span class="fc" id="L378">             PreparedStatement ps = connection.prepareStatement(query)) {</span>

<span class="fc" id="L380">            ps.setString(1, userEmail);</span>
<span class="fc" id="L381">            try (ResultSet rs = ps.executeQuery()) {</span>
<span class="fc bfc" id="L382" title="All 2 branches covered.">                while (rs.next()) {</span>
<span class="fc" id="L383">                    ProdottoBean prodotto = new ProdottoBean();</span>
<span class="fc" id="L384">                    prodotto.setId(rs.getString(&quot;id&quot;));</span>
<span class="fc" id="L385">                    prodotto.setName(rs.getString(&quot;name&quot;));</span>
<span class="fc" id="L386">                    prodotto.setPiecesInStock(rs.getInt(&quot;pieces_in_stock&quot;));</span>
<span class="fc" id="L387">                    prodotto.setCost(rs.getDouble(&quot;cost&quot;));</span>
<span class="fc" id="L388">                    prodotto.setQty(rs.getInt(&quot;quantity&quot;));</span>
<span class="fc" id="L389">                    cart.add(prodotto);</span>
<span class="fc" id="L390">                }</span>
            }
        }
<span class="fc" id="L393">        return cart;</span>
    }

    /*@ public normal_behavior
      @   requires userEmail != null &amp;&amp; !userEmail.isEmpty()
      @        &amp;&amp; productId != null &amp;&amp; !productId.isEmpty()
      @        &amp;&amp; qty &gt;= 0;
      @   assignable \everything;
      @   ensures available;
      @*/
    @Override
    public void updateCartProductQuantityInDatabase(String userEmail, String productId, int qty) throws SQLException {
<span class="fc" id="L405">        String query = &quot;&quot;&quot;</span>
        UPDATE ProdottoCarrello
        SET quantity = ?
        WHERE prodotto_id = ?
          AND carrello_id = (
              SELECT id FROM Carrello WHERE cliente_email = ?
          )
        &quot;&quot;&quot;;

<span class="fc" id="L414">        try (Connection connection = ds.getConnection();</span>
<span class="fc" id="L415">             PreparedStatement stmt = connection.prepareStatement(query)) {</span>

<span class="fc" id="L417">            stmt.setInt(1, qty);</span>
<span class="fc" id="L418">            stmt.setString(2, productId);</span>
<span class="fc" id="L419">            stmt.setString(3, userEmail);</span>

<span class="fc" id="L421">            stmt.executeUpdate();</span>
        }
<span class="fc" id="L423">    }</span>


    /*@ public normal_behavior
      @   requires userEmail != null &amp;&amp; !userEmail.isEmpty()
      @        &amp;&amp; productId != null &amp;&amp; !productId.isEmpty();
      @   assignable \everything;
      @   ensures available;
      @*/
    @Override
    public void removeProductFromCart(String userEmail, String productId) throws SQLException {
<span class="fc" id="L434">        String query = &quot;&quot;&quot;</span>
        DELETE FROM ProdottoCarrello
        WHERE prodotto_id = ?
          AND carrello_id = (
              SELECT id FROM Carrello WHERE cliente_email = ?
          )
        &quot;&quot;&quot;;

<span class="fc" id="L442">        try (Connection connection = ds.getConnection();</span>
<span class="fc" id="L443">             PreparedStatement stmt = connection.prepareStatement(query)) {</span>

<span class="fc" id="L445">            stmt.setString(1, productId);</span>
<span class="fc" id="L446">            stmt.setString(2, userEmail);</span>

<span class="fc" id="L448">            stmt.executeUpdate();</span>
        }
<span class="fc" id="L450">    }</span>


    @Override
    /*@ public normal_behavior
      @   requires id != null &amp;&amp; !id.isEmpty();
      @   assignable \everything;
      @   ensures available;
      @*/
    public void deleteProductById(String id) throws SQLException {
<span class="fc" id="L460">        String deleteProductQuery = &quot;DELETE FROM Prodotto WHERE id = ?&quot;;</span>
<span class="fc" id="L461">        String deleteFromCartQuery = &quot;DELETE FROM ProdottoCarrello WHERE prodotto_id = ?&quot;;</span>

<span class="fc" id="L463">        try (Connection connection = ds.getConnection()) {</span>
            // Rimuovi il prodotto dalla tabella ProdottoCarrello
<span class="fc" id="L465">            try (PreparedStatement cartStatement = connection.prepareStatement(deleteFromCartQuery)) {</span>
<span class="fc" id="L466">                cartStatement.setString(1, id);</span>
<span class="fc" id="L467">                cartStatement.executeUpdate();</span>
            }

            // Rimuovi il prodotto dalla tabella Prodotto
<span class="fc" id="L471">            try (PreparedStatement productStatement = connection.prepareStatement(deleteProductQuery)) {</span>
<span class="fc" id="L472">                productStatement.setString(1, id);</span>
<span class="fc" id="L473">                productStatement.executeUpdate();</span>
            }
        }
<span class="fc" id="L476">    }</span>

    @Override
    /*@ public normal_behavior
      @   requires prodottoBean != null
      @        &amp;&amp; prodottoBean.getId() != null &amp;&amp; !prodottoBean.getId().isEmpty()
      @        &amp;&amp; prodottoBean.getName() != null &amp;&amp; !prodottoBean.getName().isEmpty()
      @        &amp;&amp; prodottoBean.getBrand() != null &amp;&amp; !prodottoBean.getBrand().isEmpty()
      @        &amp;&amp; prodottoBean.getCost() &gt;= 0
      @        &amp;&amp; prodottoBean.getPiecesInStock() &gt;= 0;
      @   assignable \everything;
      @   ensures \result ==&gt; true;
      @*/
    public boolean updateProduct(ProdottoBean prodottoBean) {
<span class="fc" id="L490">        String queryProdotto =</span>
                &quot;UPDATE Prodotto SET name = ?, cost = ?, brand = ?, figure = ?, pieces_in_stock = ?, img = ?, description = ? WHERE id = ?&quot;;
<span class="fc" id="L492">        String queryProdottoCarrello =</span>
                &quot;UPDATE ProdottoCarrello SET unitary_cost = ? WHERE prodotto_id = ?&quot;;

<span class="fc" id="L495">        try (Connection conn = ds.getConnection();</span>
<span class="fc" id="L496">             PreparedStatement stmtProdotto = conn.prepareStatement(queryProdotto);</span>
<span class="fc" id="L497">             PreparedStatement stmtProdottoCarrello = conn.prepareStatement(queryProdottoCarrello)) {</span>

<span class="fc" id="L499">            stmtProdotto.setString(1, prodottoBean.getName());</span>
<span class="fc" id="L500">            stmtProdotto.setDouble(2, prodottoBean.getCost());</span>
<span class="fc" id="L501">            stmtProdotto.setString(3, prodottoBean.getBrand());</span>
<span class="fc" id="L502">            stmtProdotto.setString(4, prodottoBean.getFigure());</span>
<span class="fc" id="L503">            stmtProdotto.setInt(5, prodottoBean.getPiecesInStock());</span>
<span class="fc" id="L504">            stmtProdotto.setBytes(6, prodottoBean.getImg());</span>
<span class="fc" id="L505">            stmtProdotto.setString(7, prodottoBean.getDescription());</span>
<span class="fc" id="L506">            stmtProdotto.setString(8, prodottoBean.getId());</span>

<span class="fc" id="L508">            int rowsUpdatedProdotto = stmtProdotto.executeUpdate();</span>

            // opzionale: aggiorna carrello se esiste
<span class="fc" id="L511">            stmtProdottoCarrello.setDouble(1, prodottoBean.getCost());</span>
<span class="fc" id="L512">            stmtProdottoCarrello.setString(2, prodottoBean.getId());</span>
<span class="fc" id="L513">            stmtProdottoCarrello.executeUpdate();</span>

<span class="pc bpc" id="L515" title="1 of 2 branches missed.">            return rowsUpdatedProdotto &gt; 0;</span>

<span class="nc" id="L517">        } catch (SQLException e) {</span>
<span class="nc" id="L518">            e.printStackTrace();</span>
<span class="nc" id="L519">            return false;</span>
        }
    }


    /*@ public normal_behavior
      @   requires productId != null &amp;&amp; !productId.isEmpty()
      @        &amp;&amp; quantity &gt;= 0;
      @   assignable \everything;
      @   ensures available;
      @*/
    public void updateStock(String productId, int quantity) throws SQLException {
<span class="fc" id="L531">        String query = &quot;UPDATE Prodotto SET pieces_in_stock = CASE WHEN ? &lt;= 0 THEN 10 ELSE ? END WHERE id = ?&quot;;</span>

<span class="fc" id="L533">        try (Connection connection = ds.getConnection();</span>
<span class="fc" id="L534">             PreparedStatement statement = connection.prepareStatement(query)) {</span>

<span class="fc" id="L536">            statement.setInt(1, quantity);  // Controlla se la quantità è &lt;= 0</span>
<span class="fc" id="L537">            statement.setInt(2, quantity);  // Usa la stessa quantità se non scende a 0</span>
<span class="fc" id="L538">            statement.setString(3, productId);  // ID del prodotto</span>

<span class="fc" id="L540">            statement.executeUpdate();</span>
        }
<span class="fc" id="L542">    }</span>

    /*@ public normal_behavior
      @   requires productId1 != null &amp;&amp; !productId1.isEmpty()
      @        &amp;&amp; productId2 != null &amp;&amp; !productId2.isEmpty();
      @   assignable \everything;
      @   ensures \result ==&gt; true || !\result;
      @*/
    public boolean isAssociatedWith(String productId1, String productId2) throws SQLException {
<span class="fc" id="L551">        String query = &quot;SELECT COUNT(*) FROM ProductAssociations WHERE product_id_1 = ? AND product_id_2 = ?&quot;;</span>

<span class="fc" id="L553">        try (Connection connection = ds.getConnection();</span>
<span class="fc" id="L554">             PreparedStatement preparedStatement = connection.prepareStatement(query)) {</span>

<span class="fc" id="L556">            preparedStatement.setString(1, productId1);</span>
<span class="fc" id="L557">            preparedStatement.setString(2, productId2);</span>

<span class="fc" id="L559">            try (ResultSet resultSet = preparedStatement.executeQuery()) {</span>
<span class="pc bpc" id="L560" title="1 of 2 branches missed.">                if (resultSet.next()) {</span>
<span class="fc bfc" id="L561" title="All 2 branches covered.">                    return resultSet.getInt(1) &gt; 0;</span>
                }
<span class="pc bpc" id="L563" title="1 of 2 branches missed.">            }</span>
<span class="pc bpc" id="L564" title="2 of 4 branches missed.">        }</span>
<span class="nc" id="L565">        return false;</span>
    }



}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>